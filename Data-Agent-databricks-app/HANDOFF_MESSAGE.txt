I'm continuing work on the Data-Agent app. Full handoff is in Data-Agent/HANDOFF.md â€” read that file first.

Summary:
- Data-Agent is an AI-assisted MRRpV app; target hosting is Databricks App. Three data sources: First purchases, Upsell, Fleet overall (toggle in UI; default First purchases).
- Preset views: First Purchase MRRpV (overall), by Industry, by Geo-Segment, MRRpV Bridge, ASP Investigation. Views dropdown from GET /api/views (registry: backend/src/views/first-purchase-views.js); default 4 quarters for all. Tables: time-as-columns (overall), grouped pivot (geo-segment/industry), bridge contribution table, ASP table (Product + Metric + quarter columns). Restore unfiltered: POST /api/views/run-default (no LLM).
- User feedback: thumbs up/down on each assistant message; optional comment; POST /api/feedback, POST /api/feedback/:id/comment; Admin has GET /api/admin/feedback. Data in backend/data/feedback.json.
- Backend filters: regions, segments, excludeRegions, excludeSegments, industries, excludeIndustries (mrrpv.js, getBridgeMRRpV, getASPInvestigation). Frontend sends currentView (presetId, time_window, group_by, products, regions, segments, include_product) with chat. Agent: buildCurrentViewPrompt; never switch view when user only filters; for ASP pass segments: ["MM"] for "only MM accounts", preserve regions; when user adds product merge with current include_product (applyProductFilterMerge). view-lock.js: on ASP inject segments ["MM"] when user says "only MM accounts", preserve currentView.regions.
- getMRRpV, getBridgeMRRpV, getASPInvestigation in backend/src/queries/mrrpv.js. include_product can be array (AND). Schema: docs/mrrpv-schema-mapping.md; glossary: backend/src/queries/column-glossary.js.
- Run: npm run dev from Data-Agent root; .env in root; NODE_TLS_REJECT_UNAUTHORIZED=0 for local if needed.

Next steps (read HANDOFF.md and the plan):
- Key paths, preset-view details, and "How to continue work": see HANDOFF.md.
- Agent/prompt design: Craft broadly applicable rules (e.g. include/restore = remove from exclude_*; multi-condition in one message = pass all in one call), not narrow use-case rules. See HANDOFF.md "Agent and prompt design (critical)".
